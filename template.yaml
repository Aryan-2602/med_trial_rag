AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: CoTrial RAG v2 - FastAPI Lambda with FAISS and S3

Parameters:
  RAGBucket:
    Type: String
    Description: S3 bucket name for RAG indices
  RAGManifestKey:
    Type: String
    Default: rag/manifest.json
    Description: S3 key for manifest JSON
  EmbedModel:
    Type: String
    Default: text-embedding-3-small
    Description: Embedding model name
  OpenAIApiKey:
    Type: String
    Description: OpenAI API key (or use Secrets Manager)
    NoEcho: true

Globals:
  Function:
    Timeout: 60
    MemorySize: 2048
    Runtime: python3.11
    Environment:
      Variables:
        RAG_BUCKET: !Ref RAGBucket
        RAG_MANIFEST_KEY: !Ref RAGManifestKey
        EMBED_MODEL: !Ref EmbedModel
        OPENAI_API_KEY: !Ref OpenAIApiKey
        USE_RETRIEVER: faiss
        MAX_TOKENS: '2048'
        TOP_K: '5'
        FUSION_K: '8'

Resources:
  # EFS File System for large index storage
  RAGFileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      FileSystemTags:
        - Key: Name
          Value: rag-indices
      PerformanceMode: generalPurpose
      Encrypted: true
      LifecyclePolicies:
        - TransitionToIA: AFTER_7_DAYS

  # EFS Access Point for Lambda
  RAGAccessPoint:
    Type: AWS::EFS::AccessPoint
    Properties:
      FileSystemId: !Ref RAGFileSystem
      PosixUser:
        Uid: 1000
        Gid: 1000
      RootDirectory:
        CreationInfo:
          OwnerUid: 1000
          OwnerGid: 1000
          Permissions: 755
        Path: /rag

  # Security Group for EFS
  EFSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RAG EFS
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          SourceSecurityGroupId: !GetAtt LambdaSecurityGroup.GroupId
      Tags:
        - Key: Name
          Value: rag-efs-sg

  # Security Group for Lambda
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RAG Lambda
      VpcId: !Ref VPC
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: rag-lambda-sg

  # VPC (minimal - just for EFS)
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: rag-vpc

  # Internet Gateway for VPC (needed for S3 access)
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: rag-igw

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  # VPC Endpoint for S3 (allows S3 access without NAT Gateway)
  S3VPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref VPC
      ServiceName: !Sub com.amazonaws.${AWS::Region}.s3
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref PublicRouteTable

  # Route Table
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: rag-public-rt

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Private Subnet for Lambda (needs NAT Gateway for internet access)
  LambdaSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: rag-lambda-subnet

  # Public Subnet for NAT Gateway
  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: rag-public-subnet

  # Elastic IP for NAT Gateway
  NatGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc
      Tags:
        - Key: Name
          Value: rag-nat-eip

  # NAT Gateway (for Lambda internet access)
  NatGateway:
    Type: AWS::EC2::NatGateway
    DependsOn: InternetGatewayAttachment
    Properties:
      AllocationId: !GetAtt NatGatewayEIP.AllocationId
      SubnetId: !Ref PublicSubnet
      Tags:
        - Key: Name
          Value: rag-nat-gateway

  # Private Route Table for Lambda
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: rag-private-rt

  # Route to NAT Gateway for internet access
  DefaultPrivateRoute:
    Type: AWS::EC2::Route
    DependsOn: NatGateway
    Properties:
      RouteTableId: !Ref PrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway

  # Associate Lambda subnet with private route table
  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref LambdaSubnet
      RouteTableId: !Ref PrivateRouteTable

  # Associate public subnet with public route table
  PublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref PublicRouteTable

  # Mount Target for EFS
  EFSMountTarget:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref RAGFileSystem
      SubnetId: !Ref LambdaSubnet
      SecurityGroups:
        - !Ref EFSSecurityGroup

  # Layer for large dependencies (FAISS, NumPy)
  DependenciesLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: rag-dependencies
      Description: FAISS and NumPy for ARM64 Lambda
      ContentUri: layer/
      CompatibleRuntimes:
        - python3.11
      CompatibleArchitectures:
        - arm64
      RetentionPolicy: Retain

  RAGApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: api.server.handler
      CodeUri: src/
      Runtime: python3.11
      Architectures:
        - arm64
      MemorySize: 2048
      Timeout: 60
      Layers:
        - !Ref DependenciesLayer
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref LambdaSubnet
      FileSystemConfigs:
        - Arn: !GetAtt RAGAccessPoint.Arn
          LocalMountPath: /mnt/efs
      Environment:
        Variables:
          RAG_BUCKET: !Ref RAGBucket
          RAG_MANIFEST_KEY: !Ref RAGManifestKey
          EMBED_MODEL: !Ref EmbedModel
          OPENAI_API_KEY: !Ref OpenAIApiKey
          USE_RETRIEVER: faiss
          MAX_TOKENS: '2048'
          TOP_K: '5'
          FUSION_K: '8'
          RAG_STORAGE_PATH: /mnt/efs
      Policies:
        - S3ReadPolicy:
            BucketName: !Ref RAGBucket
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - elasticfilesystem:ClientMount
                - elasticfilesystem:ClientWrite
              Resource: !GetAtt RAGFileSystem.Arn
      Events:
        RootApi:
          Type: Api
          Properties:
            Path: /
            Method: GET
        Api:
          Type: Api
          Properties:
            Path: /{proxy+}
            Method: ANY

Outputs:
  RAGApi:
    Description: API Gateway endpoint URL
    Value: !Sub https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/
  RAGApiFunction:
    Description: RAG Lambda Function ARN
    Value: !GetAtt RAGApiFunction.Arn

